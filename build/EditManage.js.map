{"version":3,"sources":["../src/EditManage.js"],"names":["EditManage","path","_editTmpPath","_editArrWriter","_editedData","_flags","_counts","mode","data","length","forEach","id","DELETE","_addUpdatedData","JsonUtil","createObjectArrayWriter","write","end","loadJson","fs","unlinkSync","_","isEmpty","objectMode","chunk","String","UPDATE","find","createObjectArrayReadble","filter","APPEND"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;IAEqBA,U;AAMnB,sBAAYC,IAAZ,EAAkB;AAAA;;AAChB,SAAKC,YAAL,GAAoBD,IAApB;AACA,SAAKE,cAAL,GAAsB,IAAtB;AACA,SAAKC,WAAL,GAAmB,IAAnB;AACA,SAAKC,MAAL,GAAc,EAAd;AACA,SAAKC,OAAL,GAAe,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAf;AACD;;;;4BAEOC,I,EAAe;AAAA;;AAAA,wCAANC,IAAM;AAANA,YAAM;AAAA;;AACrB,WAAKF,OAAL,CAAaC,IAAb,KAAsBC,KAAKC,MAA3B;AACAD,WAAKE,OAAL,CAAa;AAAA,eAAQ,MAAKL,MAAL,CAAYG,KAAKG,EAAL,GAAU,EAAtB,IAA4BJ,IAApC;AAAA,OAAb;AACA,UAAIA,SAASP,WAAWY,MAAxB,EAAgC,KAAKC,eAAL,aAAwBL,IAAxB;AACjC;;;sCAEwB;AACvB,UAAI,CAAC,KAAKL,cAAV,EAA0B;AACxB,aAAKA,cAAL,GAAsBW,mBAASC,uBAAT,CAAiC,KAAKb,YAAtC,CAAtB;AACD;;AAHsB,yCAANM,IAAM;AAANA,YAAM;AAAA;;AAIvB,WAAKL,cAAL,CAAoBa,KAApB,CAA0BR,IAA1B;AACD;;;;;;;;;qBAGK,KAAKL,c;;;;;;uBACD,KAAKA,cAAL,CAAoBc,GAApB,E;;;AAER;AACA,qBAAKb,WAAL,GAAmBU,mBAASI,QAAT,CAAkB,KAAKhB,YAAvB,CAAnB;AACAiB,6BAAGC,UAAH,CAAc,KAAKlB,YAAnB;;;;;;;;;;;;;;;;;;+BAGS;AACT,aAAO,CAACmB,iBAAEC,OAAF,CAAU,KAAKjB,MAAf,CAAR;AACD;;;2BAEME,I,EAAM;AACX,aAAO,KAAKD,OAAL,CAAaC,IAAb,CAAP;AACD;;;0CAEqB;AAAA;;AACpB,aAAO,8BAAe;AACpBgB,oBAAY;AADQ,OAAf,EAEJ,UAACC,KAAD;AAAA,eAAW,OAAKnB,MAAL,CAAYmB,MAAMb,EAAN,GAAW,EAAvB,MAA+BX,WAAWY,MAArD;AAAA,OAFI,CAAP;AAGD;;;0CAEqB;AAAA;;AACpB,aAAO,2BAAY;AACjBW,oBAAY;AADK,OAAZ,EAEJ,UAACC,KAAD,EAAW;AACZ,YAAI,OAAKnB,MAAL,CAAYoB,OAAOD,MAAMb,EAAb,CAAZ,MAAkCX,WAAW0B,MAAjD,EAAyD;AACvD,iBAAOF,KAAP;AACD;AACD,eAAO,OAAKpB,WAAL,CAAiBuB,IAAjB,CAAsB;AAAA,iBAAQnB,KAAKG,EAAL,KAAYa,MAAMb,EAA1B;AAAA,SAAtB,KAAuDa,KAA9D;AACD,OAPM,CAAP;AAQD;;;6CAEwB;AAAA;;AACvB,aAAOV,mBAASc,wBAAT,CACL,KAAKxB,WAAL,CAAiByB,MAAjB,CAAwB,UAACrB,IAAD;AAAA,eAAU,OAAKH,MAAL,CAAYG,KAAKG,EAAL,GAAU,EAAtB,MAA8BX,WAAW8B,MAAnD;AAAA,OAAxB,CADK,CAAP;AAED;;;;;;AAhEkB9B,U,CAEZY,M,GAAS,C;AAFGZ,U,CAGZ0B,M,GAAS,C;AAHG1B,U,CAIZ8B,M,GAAS,C;kBAJG9B,U","file":"EditManage.js","sourcesContent":["import fs from 'fs';\nimport _, { reject, update } from 'lodash';\nimport JsonUtil from './util/JsonUtil';\nimport through2Filter from 'through2-filter';\nimport through2Map from 'through2-map';\n\nexport default class EditManage {\n\n  static DELETE = 0;\n  static UPDATE = 1;\n  static APPEND = 2;\n\n  constructor(path) {\n    this._editTmpPath = path;\n    this._editArrWriter = null;\n    this._editedData = null;\n    this._flags = {};\n    this._counts = [0, 0, 0];\n  }\n\n  addData(mode, ...data) {\n    this._counts[mode] += data.length;\n    data.forEach(data => this._flags[data.id + ''] = mode);\n    if (mode !== EditManage.DELETE) this._addUpdatedData(...data);\n  }\n\n  _addUpdatedData(...data) {\n    if (!this._editArrWriter) {\n      this._editArrWriter = JsonUtil.createObjectArrayWriter(this._editTmpPath);\n    }\n    this._editArrWriter.write(data);\n  }\n\n  async end() {\n    if (this._editArrWriter) {\n      await this._editArrWriter.end();\n    }\n    // TODO: 変更分が大きくてメモリ問題がでたら遅いけどファイルI/Oに変更する\n    this._editedData = JsonUtil.loadJson(this._editTmpPath);\n    fs.unlinkSync(this._editTmpPath);\n  }\n\n  isEdited() {\n    return !_.isEmpty(this._flags);\n  }\n\n  counts(mode) {\n    return this._counts[mode];\n  }\n\n  createDeletedFilter() {\n    return through2Filter({\n      objectMode: true,\n    }, (chunk) => this._flags[chunk.id + ''] !== EditManage.DELETE);\n  }\n\n  createUpdatedMapper() {\n    return through2Map({\n      objectMode: true,\n    }, (chunk) => {\n      if (this._flags[String(chunk.id)] !== EditManage.UPDATE) {\n        return chunk;\n      }\n      return this._editedData.find(data => data.id === chunk.id) || chunk;\n    });\n  }\n\n  createAppendedReadable() {\n    return JsonUtil.createObjectArrayReadble(\n      this._editedData.filter((data) => this._flags[data.id + ''] === EditManage.APPEND));\n  }\n\n}\n"]}