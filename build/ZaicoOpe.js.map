{"version":3,"sources":["../src/ZaicoOpe.js"],"names":["ZaioOpeBase","config","options","context","requester","ZaicoRequester","_editManage","EditManage","editTmpFile","filePath","path","isAbsolute","resolve","fileDir","cvtName","value","Converters","Error","type","cvt","argCvt","charAt","toLocaleUpperCase","substr","method","data","found","init","_","cloneDeep","initialValue","convert","newData","fromPairs","toPairs","Object","assign","map","key","mappingKey","replaceData","assignData","log","mapping","orgData","refData","get","forEach","k","v","Array","isArray","JSON","parse","reduce","cur","info","regexp","replace","newRep","m","p1","RegExp","stringify","cacheFile","Promise","fs","renameSync","cacheOldFile","dest","counts","DELETE","push","createDeletedFilter","UPDATE","createUpdatedMapper","cacheFileStream","JsonUtil","toJSONArrayInputStream","APPEND","cs","CombinedStream","create","append","createAppendedReadable","pipe","JSONStream","createWriteStream","on","unlinkSync","listToArrayWriter","createObjectArrayWriter","cache","fn","mapFn","obj","result","objectMode","jan","_listZaico","z","res","length","findZaicoByKey","isEdited","files","existsSync","zaicoDataToCache","end","useCache","isChangedData","updateCacheData","removeCacheData","mode","id","addData","getRes","isEmpty","dryrun","dummy","item_image","updated_at","filePaths","canProcess","beforeFiles","_processFiles","afterFiles","f","_processFile","dirname","jangetterResult","loadJson","title","rows","beforeRows","row","idx","beforeRow","_writeRowTitle","eachRow","afterRow","afterRows","fileToBase64","mimeType","mime","getType","body","readFileSync","VerifyOperation","janKey","msgs","listZaico","list","msg","join","AddOperation","force","findZaico","createRequestData","add","updateDatum","data_id","UpdateOperation","every","isEqual","update","UpdateOrAddOperation","DeleteOperation","remove","CacheUpdateOperation","DeleteDuplicateOperation","janCountsObj","_createJanCountObj","janCounts","_createDupJan2Data","dupJanObj","removeJan","arr","undefined","filter","created_at","latest","oldest","slice","d","CacheFileOperationBase","zaicos","zaico","DiffUpdateOperation","ignoreKeys","Set","code","hash","diffZaico","idHash","id2HashObj","Map","md5","crypto","createHash","digest","editZaico","cacheZaico","pickBy","has","hashObj","keys","diff","verify","args","updateAdd","delete","deleteDuplicate","diffUpdate"],"mappings":"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","file":"ZaicoOpe.js","sourcesContent":["import fs from 'fs';\nimport crypto from 'crypto';\nimport path from 'path';\nimport _ from 'lodash';\nimport readline from 'readline';\nimport { forEachSeries } from 'p-iteration';\nimport mime from 'mime';\nimport JSONStream from 'JSONStream';\nimport JsonUtil from './util/JsonUtil'\nimport ZaicoRequester from './ZaicoRequester';\nimport EditManage from './EditManage';\nimport CombinedStream from 'combined-stream';\nimport through2Filter from 'through2-filter';\nimport through2Map from 'through2-map';\n\nclass ZaioOpeBase {\n  static Converters = {\n    fileToBase64: {\n      type: 'path',\n      // <img src=\"data:image/png;base64,xxxxx...\" />\n      cvt: (filePath) => {\n        const mimeType = mime.getType(filePath.replace(/^.*\\./, ''));\n        if (mimeType === 'application/octet-stream') throw new Error(`Couldn't get mime from ${filePath}`);\n        const body = fs.readFileSync(filePath, 'base64');\n        return `data:${mimeType};base64,${body}`;\n      },\n    }\n  };\n\n  constructor(config, options) {\n    this.config = config;\n    this.options = options;\n    this.context = {};\n    this.requester = new ZaicoRequester(config, options);\n    this._editManage = new EditManage(config.editTmpFile);\n  }\n\n  _cvtArgPath(filePath) {\n    return path.isAbsolute(filePath) ? filePath : path.resolve(`${this.context.fileDir}/${filePath}`);\n  }\n\n  convert(cvtName, value) {\n    if (!cvtName) return value;\n    if (!ZaioOpeBase.Converters[cvtName]) throw new Error(`Converter ${cvtName} is not defined.`);\n    const { type, cvt } = ZaioOpeBase.Converters[cvtName];\n    const argCvt = `_cvtArg${type.charAt(0).toLocaleUpperCase()}${type.substr(1)}`;\n    if (typeof(this[argCvt]) !== 'function') throw new Error(`Converter arg processor ${argCvt} is not defined.`);\n    return cvt(this[argCvt](value));\n  }\n\n  createRequestData(method, data, found) {\n    const init = _.cloneDeep(this.config.initialValue[method] || {});\n    const convert = this.config.convert || {};\n    let newData = _.fromPairs(_.toPairs(Object.assign(init, data)).map(([key,value]) => [\n      this.mappingKey(key),\n      this.convert(convert[key], value),\n    ]));\n    newData = this.replaceData(method, newData, found);\n    newData = this.assignData(method, newData);\n    return newData;\n  }\n\n  log(...args) {\n    console.log(...args);\n  }\n\n  mappingKey(key) {\n    return this.config.mapping[key] || key;\n  }\n\n  replaceData(method, data, orgData) {\n    const refData = Object.assign({}, orgData || {}, data);\n    const replaceData = _.get(this.config, `replaceValue.${method}`);\n    if (replaceData) {\n      _.toPairs(replaceData).forEach(([k, v]) => {\n        if (!data[k] && refData[k] && Array.isArray(v)) {\n          data[k] = JSON.parse(v.reduce((cur, info) => {\n            if (Array.isArray(info.regexp) && typeof info.replace === 'string') {\n              const newRep = info.replace.replace(/\\$\\{(\\w+)\\}/g, (m, p1) => refData[p1] || '')\n              return cur.replace(new RegExp(...info.regexp), newRep);\n            }\n            return cur;\n          }, JSON.stringify(refData[k])));\n        }\n      });\n    }\n    return data;\n  }\n\n  assignData(method, data) {\n    const assignData = _.get(this.config, `assignValue.${method}`);\n    if (assignData) {\n      _.toPairs(assignData).forEach(([k, v]) => {\n        if (!data[k]) {\n          data[k] = JSON.parse(JSON.stringify(v).replace(/\\$\\{(\\w+)\\}/g, (m, p1) => data[p1] || ''));\n        }\n      })\n    }\n    return data;\n  }\n\n  updateCacheData() {\n    this.log('** update cahce', this.config.cacheFile);\n    return new Promise((resolve) => {\n      fs.renameSync(this.config.cacheFile, this.config.cacheOldFile);\n      const dest = [];\n      if (this._editManage.counts(EditManage.DELETE)) dest.push(this._editManage.createDeletedFilter());\n      if (this._editManage.counts(EditManage.UPDATE)) dest.push(this._editManage.createUpdatedMapper());\n      const cacheFileStream = JsonUtil.toJSONArrayInputStream(this.config.cacheOldFile, ...dest);\n      (this._editManage.counts(EditManage.APPEND)\n        ? () => {\n            const cs = CombinedStream.create();\n            cs.append(cacheFileStream);\n            cs.append(this._editManage.createAppendedReadable());\n            return cs;\n          }\n        : () => cacheFileStream\n      )()\n        .pipe(JSONStream.stringify())\n        .pipe(fs.createWriteStream(this.config.cacheFile))\n        .on('end', () => resolve());\n    });\n  }\n\n  removeCacheData() {\n    this.log('** remove cahce', this.config.cacheFile);\n    fs.unlinkSync(this.config.cacheFile);\n  }\n\n  async zaicoDataToCache() {\n    this.log('** get all zaico data', this.config.cacheFile);\n    return await this.requester.listToArrayWriter(JsonUtil.createObjectArrayWriter(this.config.cacheFile));\n  }\n\n  useCache() {\n    return this.options.cache && this.config.cacheFile;\n  }\n\n  async _listZaico(fn, mapFn = obj => obj) {\n    const result = [];\n    return new Promise((resolve) => {\n      JsonUtil.toJSONArrayInputStream(this.config.cacheFile)\n        .pipe(through2Filter({ objectMode: true }, fn))\n        .pipe(through2Map({ objectMode: true }, mapFn))\n        .on('data', (data) => result.push(data))\n        .on('end', () => resolve(result));\n    });\n  }\n\n  async listZaico(jan) {\n    return await this._listZaico(z => z[this.mappingKey('jan')] === jan);\n  }\n\n  async findZaicoByKey(value, key) {\n    const res = await this._listZaico(z => z[key] === value);\n    return res.length > 0 && res[0];\n  }\n\n  async findZaico(jan) {\n    return await this.findZaicoByKey(jan, this.mappingKey('jan'));\n  }\n\n  isChangedData() {\n    return this._editManage.isEdited();\n  }\n\n  canProcess(files) {\n    return files.length > 0;\n  }\n\n  async beforeFiles() {\n    if (!fs.existsSync(this.config.cacheFile)) {\n      await this.zaicoDataToCache();\n    }\n  }\n\n  async afterFiles() {\n    await this._editManage.end();\n    if (this.useCache()) {\n      // if (this.isChangedData() && !this.options.dryrun) {\n      if (this.isChangedData()) {\n        await this.updateCacheData();\n      }\n    } else {\n      this.removeCacheData();\n    }\n  }\n\n  async beforeRows() { }\n  async afterRows() { }\n  async beforeRow() { }\n  async afterRow() { }\n  async eachRow() { }\n\n  async updateDatum(mode, id, data) {\n    if (this.useCache()) {\n      if (mode === EditManage.DELETE) {\n        this._editManage.addData(mode, { id });\n      } else {\n        const getRes = await this.requester.info(id);\n        if (!_.isEmpty(getRes)) {\n          this._editManage.addData(mode, getRes.data);\n        } else if (this.options.dryrun) {\n          const dummy = { ...data, id };\n          delete dummy.item_image;\n          dummy.updated_at = '2222-22-22T22:22:22+09:00';\n          this._editManage.addData(mode, dummy);\n        }\n      }\n    }\n  }\n\n  async processFiles(filePaths) {\n    if (!this.canProcess(filePaths)) {\n      return false;\n    }\n    await this.beforeFiles();\n    await this._processFiles(filePaths);\n    await this.afterFiles();\n    return true;\n  }\n\n  async _processFiles(filePaths) {\n    await forEachSeries(filePaths, async f => await this._processFile(f))\n  }\n\n  async _processFile(filePath) {\n    this.context.filePath = filePath; // 対象ファイル\n    this.context.fileDir = path.dirname(filePath); // 対象dir\n    this.log('*** load 編集ファイル ***');\n    const jangetterResult = JsonUtil.loadJson(filePath);\n    this.log('***', jangetterResult.title, '***');\n    const rows = jangetterResult.rows;\n    if (Array.isArray(rows)) {\n      await this.beforeRows(rows);\n      await forEachSeries(rows, async (row, idx) => {\n        await this.beforeRow(row);\n        this._writeRowTitle(`* [${idx+1}/${rows.length}]`, row.title);\n        await this.eachRow(row);\n        await this.afterRow(row);\n      });\n      await this.afterRows(rows);\n    } else {\n      this.log('*** rows is not array.');\n    }\n  }\n\n  _writeRowTitle(...str) {\n    // readline.clearLine(process.stdout);\n    // readline.cursorTo(process.stdout, 0);\n    // process.stdout.write(str.join(' '));\n  }\n\n}\n\nclass VerifyOperation extends ZaioOpeBase {\n\n  async eachRow(row) {\n    const janKey = this.mappingKey('jan');\n    const msgs = ['未登録', '登録済み', '**複数登録済み**'];\n    const list = await this.listZaico(row.jan);\n    const msg = msgs[list.length > 1 ? 2 : list.length];\n    this.log(msg, list.map(row => row[janKey]).join(','));\n  }\n}\n\nclass AddOperation extends ZaioOpeBase {\n  async eachRow(row) {\n    if (!this.options.force && await this.findZaico(row.jan)) {\n      this.log('すでにJANが登録されています', row.jan, row.title);\n      return;\n    }\n    const data = this.createRequestData('add', row);\n    const res = await this.requester.add(data);\n    if (!_.isEmpty(res)) await this.updateDatum(EditManage.APPEND, res.data.data_id, data);\n  }\n}\n\nclass UpdateOperation extends ZaioOpeBase {\n  async eachRow(row) {\n    const found = await this.findZaico(row.jan);\n    if (found) {\n      const data = this.createRequestData('update', row, found);\n      if (this.options.force || !_.toPairs(data).every(([k, v]) => _.isEqual(v, found[k]))) {\n        const res = await this.requester.update(found.id, data);\n        if (!_.isEmpty(res)) await this.updateDatum(EditManage.UPDATE, found.id, found);\n      }\n    } else {\n      this.log('未登録のため更新できません', row.jan, row.title);\n    }\n  }\n}\n\nclass UpdateOrAddOperation extends ZaioOpeBase {\n  async eachRow(row) {\n    const found = await this.findZaico(row.jan);\n    if (found) {\n      const data = this.createRequestData('update', row, found);\n      if (this.options.force || !_.toPairs(data).every(([k, v]) => _.isEqual(v, found[k]))) {\n        const res = await this.requester.update(found.id, data);\n        if (!_.isEmpty(res)) await this.updateDatum(EditManage.UPDATE, found.id, found);\n      }\n    } else {\n      const data = this.createRequestData('add', row);\n      const res = await this.requester.add(data);\n      if (!_.isEmpty(res)) await this.updateDatum(EditManage.APPEND, res.data.data_id, data);\n    }\n  }\n}\n\nclass DeleteOperation extends ZaioOpeBase {\n  async eachRow(row) {\n    const found = await this.findZaico(row.jan);\n    if (found) {\n      const res = await this.requester.remove(found.id, row.jan);\n      if (!_.isEmpty(res)) await this.updateDatum(EditManage.DELETE, found.id);\n    } else {\n      this.log('未登録のため削除できません', row.jan, row.title);\n    }\n  }\n}\n\nclass CacheUpdateOperation extends ZaioOpeBase {\n  async beforeFiles() {\n    await this.zaicoDataToCache();\n  }\n\n  async _processFiles() {}\n\n  useCache() {\n    return true;\n  }\n\n  isChangedData() {\n    return false;\n  }\n\n  canProcess() {\n    return true;\n  }\n}\n\n/**\n * JANの重複を削除します。\n * - JANが重複していること\n * - 更新日時、作成日時が同じであること\n */\nclass DeleteDuplicateOperation extends ZaioOpeBase {\n\n  canProcess() {\n    return true;\n  }\n\n  async _createJanCountObj() {\n    const janKey = this.mappingKey('jan');\n    const obj = { };\n    return new Promise((resolve) => {\n      JsonUtil.toJSONArrayInputStream(this.config.cacheFile)\n        .on('data', data => {\n          const jan = data[janKey];\n          if (obj[jan]) {\n            obj[jan]++;\n          } else {\n            obj[jan] = 1;\n          }\n        })\n        .on('end', () => resolve(obj));\n    });\n  }\n\n  async _createDupJan2Data(janCountsObj) {\n    const janKey = this.mappingKey('jan');\n    const obj = { };\n    return new Promise((resolve) => {\n      JsonUtil.toJSONArrayInputStream(this.config.cacheFile)\n        .pipe(through2Filter({ objectMode: true }, data => janCountsObj[data[janKey]] > 1))\n        .on('data', data => {\n          const jan = data[janKey];\n          if (obj[jan]) {\n            obj[jan].push(data);\n          } else {\n            obj[jan] = [ data ];\n          }\n        })\n        .on('end', () => resolve(obj));\n    });\n  }\n\n  async _processFiles() {\n    const janCounts = await this._createJanCountObj();\n    const dupJanObj = await this._createDupJan2Data(janCounts);\n    const removeJan = _.toPairs(dupJanObj).map(([jan, arr]) => {\n      if (arr.length === 1) return undefined; // フィルタしてるので必ず複数だけど前のままにする\n      const data = arr.filter(v => v.created_at === v.updated_at);\n      if (data.length === arr.length) {\n        const { latest, oldest, force } = this.options;\n        if (latest) return ({ jan, data: data.slice(0, data.length - 1) });\n        if (oldest) return ({ jan, data: data.slice(1, data.length) });\n        if (!force) {\n          this.log(`重複したJANの全てが作成日・修正日が同じです[${jan}]`, ...arr.map(v => v.id));\n          return undefined;\n        }\n      } else if (data.length - arr.length > 1) {\n        const res = arr.filter(v => v.created_at !== v.updated_at);\n        this.log(`重複したJANに作成日・修正日が違うものが複数含まれます。キャッシュを更新し、verifyで確認してくださ[${jan}]`, ...res.map(v => v.id));\n      }\n      return ({ jan, data });\n    }).filter(v => v !== undefined);\n    await forEachSeries(removeJan, async ({jan, data}) => {\n      await forEachSeries(data, async d => {\n        const res = await this.requester.remove(d.id, jan);\n        if (!_.isEmpty(res)) await this.updateDatum(EditManage.DELETE, d.id);\n      });\n    });\n  }\n}\n\nclass CacheFileOperationBase extends ZaioOpeBase {\n\n  async _processFile(filePath) {\n    this.context.filePath = filePath; // 対象ファイル\n    this.context.fileDir = path.dirname(filePath); // 対象dir\n    this.log('*** load 編集ファイル ***');\n    const zaicos = JsonUtil.loadJson(filePath);\n    this.log('*** cacheファイル操作 ***');\n    if (Array.isArray(zaicos)) {\n      await this.beforeRows(zaicos);\n      await forEachSeries(zaicos, async (zaico, idx) => {\n        await this.beforeRow(zaico);\n        this._writeRowTitle(`* [${idx+1}/${zaicos.length}]`, zaico.title);\n        await this.eachRow(zaico);\n        await this.afterRow(zaico);\n      });\n      await this.afterRows(zaicos);\n    } else {\n      this.log(`*** ${filePath} is not array.`);\n    }\n  }\n}\n\nclass DiffUpdateOperation extends CacheFileOperationBase {\n\n  async beforeRows(zaicos) {\n    // 差分更新で無視するキー\n    this.ignoreKeys = new Set(_.get(this.config, 'ignoreKeys.diffUpdate', []));\n    this.log('** 差分更新前処理[cacheファイルハッシュ作成]開始 **');\n    const idHash = await this._listZaico(({ id }) => !!id, zaico => [\n      zaico.id,\n      { code: zaico.code, hash: this.hash(this.diffZaico(zaico)) },\n    ]);\n    this.id2HashObj = new Map(idHash); // キャッシュデータの id をキー、データのハッシュ文字列をバリュー\n    this.log('** 差分更新前処理[cacheファイルハッシュ作成]終了 **');\n  }\n\n  hash(obj) {\n    const md5 = crypto.createHash('md5');\n    md5.update(JSON.stringify(obj));\n    return md5.digest('hex');\n  }\n\n  /**\n   * 在庫データ同士を比較し、差分があるデータを抽出します。\n   * ignoreKeys.diffUpdateにあるキーは除外されます。\n   * キャッシュ在庫データを省略したときは編集在庫データから ignoreKeys.diffUpdateにあるキーを除外した結果を返します。\n   *\n   * @param {Object} editZaico 編集在庫データ\n   * @param {?Object} cacheZaico キャッシュ在庫データ\n   * @return {Object} 差分として残った key, value を持ったオブジェクト\n   */\n  diffZaico(editZaico, cacheZaico) {\n    return _.pickBy(editZaico, (v, k) => !this.ignoreKeys.has(k) &&\n                                          (!cacheZaico || k in cacheZaico && !_.isEqual(v, cacheZaico[k])));\n  }\n\n  async eachRow(zaico) {\n    const hashObj = this.id2HashObj.get(zaico.id);\n    if (hashObj) {\n      if (Object.keys(zaico).length === 1) { // 削除\n        const res = await this.requester.remove(zaico.id, hashObj.code);\n        if (!_.isEmpty(res)) await this.updateDatum(EditManage.DELETE, zaico.id);\n      } else { // 更新\n          // 差分をとって除外キーになってなくて違いがあるデータのハッシュ値を比較する\n        if (this.hash(this.diffZaico(zaico)) !== hashObj.hash) {\n          this.log('DIFF HASH');\n          const found = await this.findZaicoByKey(zaico.id, 'id');\n          const diff = this.diffZaico(zaico, found)\n          this.log(`\\ndiff [${found.title}] ${JSON.stringify(diff, null, 2)}\\n`);\n          const res = await this.requester.update(found.id, diff);\n          if (!_.isEmpty(res)) await this.updateDatum(EditManage.UPDATE, found.id, found);\n        }\n      }\n    } else {\n      this.log(`ID[${zaico.id}]のデータが未登録のため更新できません`, JSON.stringify(zaico));\n    }\n    // const found = await this.findZaicoByKey(zaico.id, 'id');\n    // if (found) {\n    //   if (Object.keys(zaico).length === 1) { // 削除\n    //     const res = await this.requester.remove(found.id, found.code);\n    //     if (!_.isEmpty(res)) await this.updateDatum(EditManage.DELETE, found.id);\n    //   } else { // 更新\n    //     // 差分をとって除外キーになってなくて違いがあるデータを残す\n    //     const ignore = new Set(_.get(this.config, 'ignoreKeys.diffUpdate', []));\n    //     const diff = _.pickBy(zaico, (v, k) => k in found && !ignore.has(k) && !_.isEqual(v, found[k]));\n    //     if (!_.isEmpty(diff)) {\n    //       this.log('diff', JSON.stringify(diff));\n    //       const res = await this.requester.update(found.id, diff);\n    //       if (!_.isEmpty(res)) await this.updateDatum(EditManage.UPDATE, found.id, found);\n    //     }\n    //   }\n    // } else {\n    //   this.log(`ID[${zaico.id}のデータが未登録のため更新できません`, zaico.jan, zaico.title);\n    // }\n  }\n}\n\nexport default {\n  verify: (...args) => new VerifyOperation(...args),\n  add: (...args) => new AddOperation(...args),\n  update: (...args) => new UpdateOperation(...args),\n  updateAdd: (...args) => new UpdateOrAddOperation(...args),\n  delete: (...args) => new DeleteOperation(...args),\n  deleteDuplicate: (...args) => new DeleteDuplicateOperation(...args),\n  cache: (...args) => new CacheUpdateOperation(...args),\n  diffUpdate: (...args) => new DiffUpdateOperation(...args),\n}\n"]}