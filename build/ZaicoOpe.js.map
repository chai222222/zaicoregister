{"version":3,"sources":["../src/ZaicoOpe.js"],"names":["ZaioOpeBase","config","options","context","orgData","requester","ZaicoRequester","filePath","path","isAbsolute","resolve","fileDir","cvtName","value","Converters","Error","type","cvt","argCvt","charAt","toLocaleUpperCase","substr","method","data","found","init","_","cloneDeep","initialValue","convert","assignData","fromPairs","toPairs","Object","assign","map","key","mappingKey","log","mapping","cacheFile","JsonUtil","loadJson","cloneData","fs","writeFileSync","JSON","stringify","list","cache","jan","filter","z","find","isEqual","files","length","useCache","existsSync","loadCacheData","getZaicoData","saveCacheData","isChangedData","dryrun","id","del","row","info","getRes","isEmpty","idx","findIndex","push","filePaths","canProcess","beforeFiles","_processFiles","afterFiles","f","_processFile","dirname","jangetterResult","title","rows","Array","isArray","beforeRows","beforeRow","eachRow","afterRow","afterRows","fileToBase64","mimeType","mime","getType","replace","body","readFileSync","VerifyOperation","msgs","listZaico","msg","join","AddOperation","force","findZaico","createRequestData","add","res","updateDatum","data_id","UpdateOperation","update","UpdateOrAddOperation","DeleteOperation","remove","CacheUpdateOperation","DeleteDuplicateOperation","janKey","jan2DataArr","reduce","o","val","removeJan","arr","undefined","v","created_at","updated_at","d","verify","args","updateAdd","delete","deleteDuplicate"],"mappings":";;;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;;;;;;;;;;;;;IAEMA,W;AAcJ,uBAAYC,MAAZ,EAAoBC,OAApB,EAA6B;AAAA;;AAC3B,SAAKD,MAAL,GAAcA,MAAd;AACA,SAAKC,OAAL,GAAeA,OAAf;AACA,SAAKC,OAAL,GAAe,EAAf;AACA,SAAKA,OAAL,CAAaC,OAAb,GAAuB,EAAvB;AACA,SAAKC,SAAL,GAAiB,IAAIC,wBAAJ,CAAmBL,MAAnB,EAA2BC,OAA3B,CAAjB;AACD;;;;gCAEWK,Q,EAAU;AACpB,aAAOC,eAAKC,UAAL,CAAgBF,QAAhB,IAA4BA,QAA5B,GAAuCC,eAAKE,OAAL,CAAgB,KAAKP,OAAL,CAAaQ,OAA7B,SAAwCJ,QAAxC,CAA9C;AACD;;;4BAEOK,O,EAASC,K,EAAO;AACtB,UAAI,CAACD,OAAL,EAAc,OAAOC,KAAP;AACd,UAAI,CAACb,YAAYc,UAAZ,CAAuBF,OAAvB,CAAL,EAAsC,MAAM,IAAIG,KAAJ,gBAAuBH,OAAvB,sBAAN;AAFhB,kCAGAZ,YAAYc,UAAZ,CAAuBF,OAAvB,CAHA;AAAA,UAGdI,IAHc,yBAGdA,IAHc;AAAA,UAGRC,GAHQ,yBAGRA,GAHQ;;AAItB,UAAMC,qBAAmBF,KAAKG,MAAL,CAAY,CAAZ,EAAeC,iBAAf,EAAnB,GAAwDJ,KAAKK,MAAL,CAAY,CAAZ,CAA9D;AACA,UAAI,OAAO,KAAKH,MAAL,CAAP,KAAyB,UAA7B,EAAyC,MAAM,IAAIH,KAAJ,8BAAqCG,MAArC,sBAAN;AACzC,aAAOD,IAAI,KAAKC,MAAL,EAAaL,KAAb,CAAJ,CAAP;AACD;;;sCAEiBS,M,EAAQC,I,EAAMC,K,EAAO;AAAA;;AACrC,UAAMC,OAAOC,iBAAEC,SAAF,CAAY,KAAK1B,MAAL,CAAY2B,YAAZ,CAAyBN,MAAzB,KAAoC,EAAhD,CAAb;AACA,UAAMO,UAAU,KAAK5B,MAAL,CAAY4B,OAAZ,IAAuB,EAAvC;AACA,aAAO,KAAKC,UAAL,CAAgBJ,iBAAEK,SAAF,CAAYL,iBAAEM,OAAF,CAAUC,OAAOC,MAAP,CAAcT,IAAd,EAAoBF,IAApB,CAAV,EAAqCY,GAArC,CAAyC;AAAA;AAAA,YAAEC,GAAF;AAAA,YAAMvB,KAAN;;AAAA,eAAiB,CAC3F,MAAKwB,UAAL,CAAgBD,GAAhB,CAD2F,EAE3F,MAAKP,OAAL,CAAaA,QAAQO,GAAR,CAAb,EAA2BvB,KAA3B,CAF2F,CAAjB;AAAA,OAAzC,CAAZ,CAAhB,CAAP;AAID;;;0BAEY;AAAA;;AACX,2BAAQyB,GAAR;AACD;;;+BAEUF,G,EAAK;AACd,aAAO,KAAKnC,MAAL,CAAYsC,OAAZ,CAAoBH,GAApB,KAA4BA,GAAnC;AACD;;;+BAEUb,I,EAAM;AACf;AACA,aAAOA,IAAP;AACD;;;oCAEe;AACd,WAAKe,GAAL,CAAS,eAAT,EAA0B,KAAKrC,MAAL,CAAYuC,SAAtC;AACA,WAAKrC,OAAL,CAAaoB,IAAb,GAAoBkB,mBAASC,QAAT,CAAkB,KAAKzC,MAAL,CAAYuC,SAA9B,CAApB;AACA,WAAKG,SAAL;AACD;;;oCAEe;AACd,WAAKL,GAAL,CAAS,gBAAT,EAA2B,KAAKrC,MAAL,CAAYuC,SAAvC;AACAI,mBAAGC,aAAH,CAAiB,KAAK5C,MAAL,CAAYuC,SAA7B,EAAwCM,KAAKC,SAAL,CAAe,KAAK5C,OAAL,CAAaoB,IAA5B,EAAkC,IAAlC,EAAwC,IAAxC,CAAxC,EAAuF,OAAvF;AACA,WAAKoB,SAAL;AACD;;;;;;;;;AAGC,qBAAKL,GAAL,CAAS,aAAT,EAAwB,KAAKrC,MAAL,CAAYuC,SAApC;;uBACa,KAAKnC,SAAL,CAAe2C,IAAf,E;;;;;;;;;;;;;;;;;;;;;+BAGJ;AACT,aAAO,KAAK9C,OAAL,CAAa+C,KAAb,IAAsB,KAAKhD,MAAL,CAAYuC,SAAzC;AACD;;;8BAESU,G,EAAK;AAAA;;AACb,aAAO,KAAK/C,OAAL,CAAaoB,IAAb,CAAkB4B,MAAlB,CAAyB;AAAA,eAAKC,EAAE,OAAKf,UAAL,CAAgB,KAAhB,CAAF,MAA8Ba,GAAnC;AAAA,OAAzB,CAAP;AACD;;;8BAESA,G,EAAK;AAAA;;AACb,aAAO,KAAK/C,OAAL,CAAaoB,IAAb,CAAkB8B,IAAlB,CAAuB;AAAA,eAAKD,EAAE,OAAKf,UAAL,CAAgB,KAAhB,CAAF,MAA8Ba,GAAnC;AAAA,OAAvB,CAAP;AACD;;;gCAEW;AACV,WAAK/C,OAAL,CAAaC,OAAb,GAAuBsB,iBAAEC,SAAF,CAAY,KAAKxB,OAAL,CAAaoB,IAAzB,CAAvB;AACD;;;oCAEe;AACd,aAAO,CAACG,iBAAE4B,OAAF,CAAU,KAAKnD,OAAL,CAAaoB,IAAvB,EAA6B,KAAKpB,OAAL,CAAaC,OAA1C,CAAR;AACD;;;+BAEUmD,K,EAAO;AAChB,aAAOA,MAAMC,MAAN,GAAe,CAAtB;AACD;;;;;;;;;;qBAGK,KAAKC,QAAL,E;;;;;qBACEb,aAAGc,UAAH,CAAc,KAAKzD,MAAL,CAAYuC,SAA1B,C;;;;;AACF,qBAAKmB,aAAL;;;;AAIJ,qBAAKxD,OAAL,CAAaoB,IAAb,GAAoB,EAApB;;uBACmB,KAAKqC,YAAL,E;;;AAAbZ,oB;;AACN,oBAAIA,IAAJ,EAAU;AACR,uBAAK7C,OAAL,CAAaoB,IAAb,GAAoByB,IAApB;AACA,sBAAI,KAAKS,QAAL,EAAJ,EAAqB;AACnB,yBAAKI,aAAL;AACD;AACF;;;;;;;;;;;;;;;;;;;;;;;;AAID,oBAAI,KAAKJ,QAAL,MAAmB,KAAKK,aAAL,EAAnB,IAA2C,CAAC,KAAK5D,OAAL,CAAa6D,MAA7D,EAAqE;AACnE,uBAAKF,aAAL;AACD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;6FASeG,E;YAAIC,G,uEAAM,K;;;;;;qBACtB,KAAKR,QAAL,E;;;;;qBACEQ,G;;;;;AACF,qBAAK9D,OAAL,CAAaoB,IAAb,GAAoB,KAAKpB,OAAL,CAAaoB,IAAb,CAAkB4B,MAAlB,CAAyB;AAAA,yBAAOe,IAAIF,EAAJ,KAAWA,EAAlB;AAAA,iBAAzB,CAApB;;;;;;uBAEqB,KAAK3D,SAAL,CAAe8D,IAAf,CAAoBH,EAApB,C;;;AAAfI,sB;;AACN,oBAAI,CAAC1C,iBAAE2C,OAAF,CAAUD,MAAV,CAAL,EAAwB;AAChBE,qBADgB,GACV,KAAKnE,OAAL,CAAaoB,IAAb,CAAkBgD,SAAlB,CAA4B;AAAA,2BAAOL,IAAIF,EAAJ,KAAWA,EAAlB;AAAA,mBAA5B,CADU;;AAEtB,sBAAIM,OAAO,CAAX,EAAc;AACZ,yBAAKnE,OAAL,CAAaoB,IAAb,CAAkB+C,GAAlB,IAAyBF,OAAO7C,IAAhC;AACD,mBAFD,MAEO;AACL,yBAAKpB,OAAL,CAAaoB,IAAb,CAAkBiD,IAAlB,CAAuBJ,OAAO7C,IAA9B;AACD;AACF;;;;;;;;;;;;;;;;;;;8FAKYkD,S;;;;;oBACZ,KAAKC,UAAL,CAAgBD,SAAhB,C;;;;;mDACI,K;;;;uBAEH,KAAKE,WAAL,E;;;;uBACA,KAAKC,aAAL,CAAmBH,SAAnB,C;;;;uBACA,KAAKI,UAAL,E;;;mDACC,I;;;;;;;;;;;;;;;;;;;8FAGWJ,S;;;;;;;;uBACZ,+BAAcA,SAAd;AAAA,uFAAyB,mBAAMK,CAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCAAiB,OAAKC,YAAL,CAAkBD,CAAlB,CAAjB;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAzB;;AAAA;AAAA;AAAA;AAAA,oB;;;;;;;;;;;;;;;;;;;8FAGWvE,Q;;;;;;;;AACjB,qBAAKJ,OAAL,CAAaI,QAAb,GAAwBA,QAAxB,C,CAAkC;AAClC,qBAAKJ,OAAL,CAAaQ,OAAb,GAAuBH,eAAKwE,OAAL,CAAazE,QAAb,CAAvB,C,CAA+C;AACzC0E,+B,GAAkBxC,mBAASC,QAAT,CAAkBnC,QAAlB,C;;AACxB,qBAAK+B,GAAL,CAAS,KAAT,EAAgB2C,gBAAgBC,KAAhC,EAAuC,KAAvC;AACMC,oB,GAAOF,gBAAgBE,I;;qBACzBC,MAAMC,OAAN,CAAcF,IAAd,C;;;;;;uBACI,KAAKG,UAAL,CAAgBH,IAAhB,C;;;;uBACA,+BAAcA,IAAd;AAAA,uFAAoB,mBAAMjB,GAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCAClB,OAAKqB,SAAL,CAAerB,GAAf,CADkB;;AAAA;AAExB,mCAAK5B,GAAL,CAAS,GAAT,EAAc4B,IAAIgB,KAAlB;AAFwB;AAAA,mCAGlB,OAAKM,OAAL,CAAatB,GAAb,CAHkB;;AAAA;AAAA;AAAA,mCAIlB,OAAKuB,QAAL,CAAcvB,GAAd,CAJkB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAApB;;AAAA;AAAA;AAAA;AAAA,oB;;;;uBAMA,KAAKwB,SAAL,CAAeP,IAAf,C;;;;;;;AAEN,qBAAK7C,GAAL,CAAS,wBAAT;;;;;;;;;;;;;;;;;;;;;AA/KAtC,W,CACGc,U,GAAa;AAClB6E,gBAAc;AACZ3E,UAAM,MADM;AAEZ;AACAC,SAAK,aAACV,QAAD,EAAc;AACjB,UAAMqF,WAAWC,eAAKC,OAAL,CAAavF,SAASwF,OAAT,CAAiB,OAAjB,EAA0B,EAA1B,CAAb,CAAjB;AACA,UAAIH,aAAa,0BAAjB,EAA6C,MAAM,IAAI7E,KAAJ,8BAAoCR,QAApC,CAAN;AAC7C,UAAMyF,OAAOpD,aAAGqD,YAAH,CAAgB1F,QAAhB,EAA0B,QAA1B,CAAb;AACA,uBAAeqF,QAAf,gBAAkCI,IAAlC;AACD;AARW;AADI,C;;IAmLhBE,e;;;;;;;;;;;;8FAEUhC,G;;;;;;AACNiC,oB,GAAO,CAAC,KAAD,EAAQ,MAAR,EAAgB,YAAhB,C;AACPnD,oB,GAAO,KAAKoD,SAAL,CAAelC,IAAIhB,GAAnB,C;AACPmD,mB,GAAMF,KAAKnD,KAAKQ,MAAL,GAAc,CAAd,GAAkB,CAAlB,GAAsBR,KAAKQ,MAAhC,C;;AACZ,qBAAKlB,GAAL,CAAS+D,GAAT,EAAcrD,KAAKb,GAAL,CAAS;AAAA,yBAAO+B,IAAIhB,GAAX;AAAA,iBAAT,EAAyBoD,IAAzB,CAA8B,GAA9B,CAAd;;;;;;;;;;;;;;;;;;;EAN0BtG,W;;IAUxBuG,Y;;;;;;;;;;;;8FACUrC,G;;;;;;sBACR,CAAC,KAAKhE,OAAL,CAAasG,KAAd,IAAuB,KAAKC,SAAL,CAAevC,IAAIhB,GAAnB,C;;;;;AACzB,qBAAKZ,GAAL,CAAS,iBAAT,EAA4B4B,IAAIhB,GAAhC,EAAqCgB,IAAIgB,KAAzC;;;;AAGI3D,oB,GAAO,KAAKmF,iBAAL,CAAuB,KAAvB,EAA8BxC,GAA9B,C;;uBACK,KAAK7D,SAAL,CAAesG,GAAf,CAAmBpF,IAAnB,C;;;AAAZqF,mB;;oBACDlF,iBAAE2C,OAAF,CAAUuC,GAAV,C;;;;;;uBAAsB,KAAKC,WAAL,CAAiBD,IAAIrF,IAAJ,CAASuF,OAA1B,C;;;;;;;;;;;;;;;;;;;EARJ9G,W;;IAYrB+G,e;;;;;;;;;;;;8FACU7C,G;;;;;;AACN1C,qB,GAAQ,KAAKiF,SAAL,CAAevC,IAAIhB,GAAnB,C;;qBACV1B,K;;;;;AACID,oB,GAAO,KAAKmF,iBAAL,CAAuB,QAAvB,EAAiCxC,GAAjC,EAAsC1C,KAAtC,C;;uBACK,KAAKnB,SAAL,CAAe2G,MAAf,CAAsBxF,MAAMwC,EAA5B,EAAgCzC,IAAhC,C;;;AAAZqF,mB;;oBACDlF,iBAAE2C,OAAF,CAAUuC,GAAV,C;;;;;;uBAAsB,KAAKC,WAAL,CAAiBrF,MAAMwC,EAAvB,C;;;;;;;AAE3B,qBAAK1B,GAAL,CAAS,eAAT,EAA0B4B,IAAIhB,GAA9B,EAAmCgB,IAAIgB,KAAvC;;;;;;;;;;;;;;;;;;;EARwBlF,W;;IAaxBiH,oB;;;;;;;;;;;;8FACU/C,G;;;;;;;AACN1C,qB,GAAQ,KAAKiF,SAAL,CAAevC,IAAIhB,GAAnB,C;;qBACV1B,K;;;;;AACID,oB,GAAO,KAAKmF,iBAAL,CAAuB,QAAvB,EAAiCxC,GAAjC,EAAsC1C,KAAtC,C;;uBACK,KAAKnB,SAAL,CAAe2G,MAAf,CAAsBxF,MAAMwC,EAA5B,EAAgCzC,IAAhC,C;;;AAAZqF,mB;;oBACDlF,iBAAE2C,OAAF,CAAUuC,GAAV,C;;;;;;uBAAsB,KAAKC,WAAL,CAAiBrF,MAAMwC,EAAvB,C;;;;;;;AAErBzC,qB,GAAO,KAAKmF,iBAAL,CAAuB,KAAvB,EAA8BxC,GAA9B,C;;uBACK,KAAK7D,SAAL,CAAesG,GAAf,CAAmBpF,KAAnB,C;;;AAAZqF,oB;;oBACDlF,iBAAE2C,OAAF,CAAUuC,IAAV,C;;;;;;uBAAsB,KAAKC,WAAL,CAAiBD,KAAIrF,IAAJ,CAASuF,OAA1B,C;;;;;;;;;;;;;;;;;;;EAVE9G,W;;IAe7BkH,e;;;;;;;;;;;;8FACUhD,G;;;;;;AACN1C,qB,GAAQ,KAAKiF,SAAL,CAAevC,IAAIhB,GAAnB,C;;qBACV1B,K;;;;;;uBACgB,KAAKnB,SAAL,CAAe8G,MAAf,CAAsB3F,MAAMwC,EAA5B,EAAgCE,IAAIhB,GAApC,C;;;AAAZ0D,mB;;oBACDlF,iBAAE2C,OAAF,CAAUuC,GAAV,C;;;;;;uBAAsB,KAAKC,WAAL,CAAiBrF,MAAMwC,EAAvB,EAA2B,IAA3B,C;;;;;;;AAE3B,qBAAK1B,GAAL,CAAS,eAAT,EAA0B4B,IAAIhB,GAA9B,EAAmCgB,IAAIgB,KAAvC;;;;;;;;;;;;;;;;;;;EAPwBlF,W;;IAYxBoH,oB;;;;;;;;;;;;;;;;;;;uBAEiB,KAAKxD,YAAL,E;;;AAAbZ,oB;;AACN,oBAAIA,IAAJ,EAAU,KAAK7C,OAAL,CAAaoB,IAAb,GAAoByB,IAApB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;+BAKD;AACT,aAAO,IAAP;AACD;;;oCAEe;AACd,aAAO,IAAP;AACD;;;iCAEY;AACX,aAAO,IAAP;AACD;;;;EAlBgChD,W;;AAqBnC;;;;;;;IAKMqH,wB;;;;;;;;;;;iCAES;AACX,aAAO,IAAP;AACD;;;;;;;;;;;;AAGOC,sB,GAAS,KAAKjF,UAAL,CAAgB,KAAhB,C;AACTkF,2B,GAAc,KAAKpH,OAAL,CAAaoB,IAAb,CAAkBiG,MAAlB,CAAyB,UAACC,CAAD,EAAIC,GAAJ,EAAY;AACvD,mBAACD,EAAEC,IAAIJ,MAAJ,CAAF,MAAmBG,EAAEC,IAAIJ,MAAJ,CAAF,IAAiB,EAApC,CAAD,EAA0C9C,IAA1C,CAA+CkD,GAA/C;AACA,yBAAOD,CAAP;AACD,iBAHmB,EAGjB,EAHiB,C;AAIdE,yB,GAAYjG,iBAAEM,OAAF,CAAUuF,WAAV,EAAuBpF,GAAvB,CAA2B,kBAAgB;AAAA;AAAA,sBAAde,GAAc;AAAA,sBAAT0E,GAAS;;AAC3D,sBAAIA,IAAIpE,MAAJ,KAAe,CAAnB,EAAsB,OAAOqE,SAAP;AACtB,sBAAMtG,OAAOqG,IAAIzE,MAAJ,CAAW;AAAA,2BAAK2E,EAAEC,UAAF,KAAiBD,EAAEE,UAAxB;AAAA,mBAAX,CAAb;AACA,sBAAI,CAAC,QAAK9H,OAAL,CAAasG,KAAd,IAAuBjF,KAAKiC,MAAL,KAAgBoE,IAAIpE,MAA/C,EAAuD;AACrD,4BAAKlB,GAAL,kJAAoCY,GAApC,kCAA+C0E,IAAIzF,GAAJ,CAAQ;AAAA,6BAAK2F,EAAE9D,EAAP;AAAA,qBAAR,CAA/C;AACA,2BAAO6D,SAAP;AACD;AACD,yBAAQ,EAAE3E,QAAF,EAAO3B,UAAP,EAAR;AACD,iBARiB,EAQf4B,MARe,CAQR;AAAA,yBAAK2E,MAAMD,SAAX;AAAA,iBARQ,C;;uBASZ,+BAAcF,SAAd;AAAA,uFAAyB;AAAA,wBAAQzE,GAAR,UAAQA,GAAR;AAAA,wBAAa3B,IAAb,UAAaA,IAAb;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCACvB,+BAAcA,IAAd;AAAA,mGAAoB,mBAAM0G,CAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+CACN,QAAK5H,SAAL,CAAe8G,MAAf,CAAsBc,EAAEjE,EAAxB,EAA4Bd,GAA5B,CADM;;AAAA;AAClB0D,2CADkB;;AAAA,4CAEnBlF,iBAAE2C,OAAF,CAAUuC,GAAV,CAFmB;AAAA;AAAA;AAAA;;AAAA;AAAA,+CAEG,QAAKC,WAAL,CAAiBoB,EAAEjE,EAAnB,EAAuB,IAAvB,CAFH;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAApB;;AAAA;AAAA;AAAA;AAAA,gCADuB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAzB;;AAAA;AAAA;AAAA;AAAA,oB;;;;;;;;;;;;;;;;;;;EArB6BhE,W;;kBA8BxB;AACbkI,UAAQ;AAAA,sCAAIC,IAAJ;AAAIA,UAAJ;AAAA;;AAAA,8CAAiBjC,eAAjB,gBAAoCiC,IAApC;AAAA,GADK;AAEbxB,OAAK;AAAA,uCAAIwB,IAAJ;AAAIA,UAAJ;AAAA;;AAAA,8CAAiB5B,YAAjB,gBAAiC4B,IAAjC;AAAA,GAFQ;AAGbnB,UAAQ;AAAA,uCAAImB,IAAJ;AAAIA,UAAJ;AAAA;;AAAA,8CAAiBpB,eAAjB,gBAAoCoB,IAApC;AAAA,GAHK;AAIbC,aAAW;AAAA,uCAAID,IAAJ;AAAIA,UAAJ;AAAA;;AAAA,8CAAiBlB,oBAAjB,gBAAyCkB,IAAzC;AAAA,GAJE;AAKbE,UAAQ;AAAA,uCAAIF,IAAJ;AAAIA,UAAJ;AAAA;;AAAA,8CAAiBjB,eAAjB,gBAAoCiB,IAApC;AAAA,GALK;AAMbG,mBAAiB;AAAA,uCAAIH,IAAJ;AAAIA,UAAJ;AAAA;;AAAA,8CAAiBd,wBAAjB,gBAA6Cc,IAA7C;AAAA,GANJ;AAOblF,SAAO;AAAA,uCAAIkF,IAAJ;AAAIA,UAAJ;AAAA;;AAAA,8CAAiBf,oBAAjB,gBAAyCe,IAAzC;AAAA;AAPM,C","file":"ZaicoOpe.js","sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport _ from 'lodash';\nimport { forEachSeries } from 'p-iteration';\nimport mime from 'mime';\nimport JsonUtil from './util/JsonUtil'\nimport ZaicoRequester from './ZaicoRequester';\n\nclass ZaioOpeBase {\n  static Converters = {\n    fileToBase64: {\n      type: 'path',\n      // <img src=\"data:image/png;base64,xxxxx...\" />\n      cvt: (filePath) => {\n        const mimeType = mime.getType(filePath.replace(/^.*\\./, ''));\n        if (mimeType === 'application/octet-stream') throw new Error(`Couldn't get mime from ${filePath}`);\n        const body = fs.readFileSync(filePath, 'base64');\n        return `data:${mimeType};base64,${body}`;\n      },\n    }\n  };\n\n  constructor(config, options) {\n    this.config = config;\n    this.options = options;\n    this.context = {};\n    this.context.orgData = [];\n    this.requester = new ZaicoRequester(config, options);\n  }\n\n  _cvtArgPath(filePath) {\n    return path.isAbsolute(filePath) ? filePath : path.resolve(`${this.context.fileDir}/${filePath}`);\n  }\n\n  convert(cvtName, value) {\n    if (!cvtName) return value;\n    if (!ZaioOpeBase.Converters[cvtName]) throw new Error(`Converter ${cvtName} is not defined.`);\n    const { type, cvt } = ZaioOpeBase.Converters[cvtName];\n    const argCvt = `_cvtArg${type.charAt(0).toLocaleUpperCase()}${type.substr(1)}`;\n    if (typeof(this[argCvt]) !== 'function') throw new Error(`Converter arg processor ${argCvt} is not defined.`);\n    return cvt(this[argCvt](value));\n  }\n\n  createRequestData(method, data, found) {\n    const init = _.cloneDeep(this.config.initialValue[method] || {});\n    const convert = this.config.convert || {};\n    return this.assignData(_.fromPairs(_.toPairs(Object.assign(init, data)).map(([key,value]) => [\n      this.mappingKey(key),\n      this.convert(convert[key], value),\n    ])));\n  }\n\n  log(...args) {\n    console.log(...args);\n  }\n\n  mappingKey(key) {\n    return this.config.mapping[key] || key;\n  }\n\n  assignData(data) {\n    // TODO: optional_attributes対策を考える\n    return data;\n  }\n\n  loadCacheData() {\n    this.log('** read cahce', this.config.cacheFile);\n    this.context.data = JsonUtil.loadJson(this.config.cacheFile);\n    this.cloneData();\n  }\n\n  saveCacheData() {\n    this.log('** write cahce', this.config.cacheFile);\n    fs.writeFileSync(this.config.cacheFile, JSON.stringify(this.context.data, null, '  '), 'utf-8');\n    this.cloneData();\n  }\n\n  async getZaicoData() {\n    this.log('** get list', this.config.cacheFile);\n    return await this.requester.list();\n  }\n\n  useCache() {\n    return this.options.cache && this.config.cacheFile;\n  }\n\n  listZaico(jan) {\n    return this.context.data.filter(z => z[this.mappingKey('jan')] === jan);\n  }\n\n  findZaico(jan) {\n    return this.context.data.find(z => z[this.mappingKey('jan')] === jan);\n  }\n\n  cloneData() {\n    this.context.orgData = _.cloneDeep(this.context.data);\n  }\n\n  isChangedData() {\n    return !_.isEqual(this.context.data, this.context.orgData);\n  }\n\n  canProcess(files) {\n    return files.length > 0;\n  }\n\n  async beforeFiles() {\n    if (this.useCache()) {\n      if (fs.existsSync(this.config.cacheFile)) {\n        this.loadCacheData();\n        return;\n      }\n    }\n    this.context.data = [];\n    const list = await this.getZaicoData();\n    if (list) {\n      this.context.data = list;\n      if (this.useCache()) {\n        this.saveCacheData();\n      }\n    }\n  }\n\n  async afterFiles() {\n    if (this.useCache() && this.isChangedData() && !this.options.dryrun) {\n      this.saveCacheData();\n    }\n  }\n\n  async beforeRows() { }\n  async afterRows() { }\n  async beforeRow() { }\n  async afterRow() { }\n  async eachRow() { }\n\n  async updateDatum(id, del = false) {\n    if (this.useCache()) {\n      if (del) {\n        this.context.data = this.context.data.filter(row => row.id !== id);\n      } else {\n        const getRes = await this.requester.info(id);\n        if (!_.isEmpty(getRes)) {\n          const idx = this.context.data.findIndex(row => row.id === id);\n          if (idx >= 0) {\n            this.context.data[idx] = getRes.data;\n          } else {\n            this.context.data.push(getRes.data);\n          }\n        }\n      }\n    }\n  }\n\n  async processFiles(filePaths) {\n    if (!this.canProcess(filePaths)) {\n      return false;\n    }\n    await this.beforeFiles();\n    await this._processFiles(filePaths);\n    await this.afterFiles();\n    return true;\n  }\n\n  async _processFiles(filePaths) {\n    await forEachSeries(filePaths, async f => await this._processFile(f))\n  }\n\n  async _processFile(filePath) {\n    this.context.filePath = filePath; // 対象ファイル\n    this.context.fileDir = path.dirname(filePath); // 対象dir\n    const jangetterResult = JsonUtil.loadJson(filePath);\n    this.log('***', jangetterResult.title, '***');\n    const rows = jangetterResult.rows;\n    if (Array.isArray(rows)) {\n      await this.beforeRows(rows);\n      await forEachSeries(rows, async row => {\n        await this.beforeRow(row);\n        this.log('*', row.title);\n        await this.eachRow(row);\n        await this.afterRow(row);\n      });\n      await this.afterRows(rows);\n    } else {\n      this.log('*** rows is not array.');\n    }\n  }\n}\n\nclass VerifyOperation extends ZaioOpeBase {\n\n  async eachRow(row) {\n    const msgs = ['未登録', '登録済み', '**複数登録済み**'];\n    const list = this.listZaico(row.jan);\n    const msg = msgs[list.length > 1 ? 2 : list.length];\n    this.log(msg, list.map(row => row.jan).join(','));\n  }\n}\n\nclass AddOperation extends ZaioOpeBase {\n  async eachRow(row) {\n    if (!this.options.force && this.findZaico(row.jan)) {\n      this.log('すでにJANが登録されています', row.jan, row.title);\n      return;\n    }\n    const data = this.createRequestData('add', row);\n    const res = await this.requester.add(data);\n    if (!_.isEmpty(res)) await this.updateDatum(res.data.data_id);\n  }\n}\n\nclass UpdateOperation extends ZaioOpeBase {\n  async eachRow(row) {\n    const found = this.findZaico(row.jan);\n    if (found) {\n      const data = this.createRequestData('update', row, found);\n      const res = await this.requester.update(found.id, data);\n      if (!_.isEmpty(res)) await this.updateDatum(found.id);\n    } else {\n      this.log('未登録のため更新できません', row.jan, row.title);\n    }\n  }\n}\n\nclass UpdateOrAddOperation extends ZaioOpeBase {\n  async eachRow(row) {\n    const found = this.findZaico(row.jan);\n    if (found) {\n      const data = this.createRequestData('update', row, found);\n      const res = await this.requester.update(found.id, data);\n      if (!_.isEmpty(res)) await this.updateDatum(found.id);\n    } else {\n      const data = this.createRequestData('add', row);\n      const res = await this.requester.add(data);\n      if (!_.isEmpty(res)) await this.updateDatum(res.data.data_id);\n    }\n  }\n}\n\nclass DeleteOperation extends ZaioOpeBase {\n  async eachRow(row) {\n    const found = this.findZaico(row.jan);\n    if (found) {\n      const res = await this.requester.remove(found.id, row.jan);\n      if (!_.isEmpty(res)) await this.updateDatum(found.id, true);\n    } else {\n      this.log('未登録のため削除できません', row.jan, row.title);\n    }\n  }\n}\n\nclass CacheUpdateOperation extends ZaioOpeBase {\n  async beforeFiles() {\n    const list = await this.getZaicoData();\n    if (list) this.context.data = list;\n  }\n\n  async _processFiles() {}\n\n  useCache() {\n    return true;\n  }\n\n  isChangedData() {\n    return true;\n  }\n\n  canProcess() {\n    return true;\n  }\n}\n\n/**\n * JANの重複を削除します。\n * - JANが重複していること\n * - 更新日時、作成日時が同じであること\n */\nclass DeleteDuplicateOperation extends ZaioOpeBase {\n\n  canProcess() {\n    return true;\n  }\n\n  async _processFiles() {\n    const janKey = this.mappingKey('jan');\n    const jan2DataArr = this.context.data.reduce((o, val) => {\n      (o[val[janKey]] || (o[val[janKey]] = [])).push(val);\n      return o;\n    }, {})\n    const removeJan = _.toPairs(jan2DataArr).map(([jan, arr]) => {\n      if (arr.length === 1) return undefined;\n      const data = arr.filter(v => v.created_at === v.updated_at);\n      if (!this.options.force && data.length === arr.length) {\n        this.log(`重複したJANの全てが作成日・修正日が同じです[${jan}]`, ...arr.map(v => v.id));\n        return undefined;\n      }\n      return ({ jan, data });\n    }).filter(v => v !== undefined);\n    await forEachSeries(removeJan, async ({jan, data}) => {\n      await forEachSeries(data, async d => {\n        const res = await this.requester.remove(d.id, jan);\n        if (!_.isEmpty(res)) await this.updateDatum(d.id, true);\n      });\n    });\n  }\n}\n\nexport default {\n  verify: (...args) => new VerifyOperation(...args),\n  add: (...args) => new AddOperation(...args),\n  update: (...args) => new UpdateOperation(...args),\n  updateAdd: (...args) => new UpdateOrAddOperation(...args),\n  delete: (...args) => new DeleteOperation(...args),\n  deleteDuplicate: (...args) => new DeleteDuplicateOperation(...args),\n  cache: (...args) => new CacheUpdateOperation(...args),\n}\n"]}