{"version":3,"sources":["../src/ZaicoOpe.js"],"names":["ZaioOpeBase","config","options","context","filePath","path","isAbsolute","resolve","fileDir","cvtName","value","Converters","Error","type","cvt","argCvt","charAt","toLocaleUpperCase","substr","method","data","init","initialValue","convert","_","fromPairs","toPairs","Object","assign","map","key","mappingKey","Authorization","token","log","err","response","console","status","statusText","headers","request","message","stack","mapping","cacheFile","JSON","parse","fs","readFileSync","writeFileSync","stringify","cache","jan","find","z","useCache","existsSync","loadContextData","createRequestHeaders","axios","get","apiUrl","catch","e","res","saveContextData","dirname","jangetterResult","title","rows","Array","isArray","beforeRows","forEach","beforeRow","row","eachRow","afterRow","afterRows","fileToBase64","mimeType","mime","getType","replace","body","VerifyOperation","found","findZaico","msg","AddOperation","createRequestData","post","data_id","getRes","push","UpdateOperation","put","id","DeleteOperation","delete","verify","args","add","update"],"mappings":"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","file":"ZaicoOpe.js","sourcesContent":["import axios from 'axios';\nimport fs from 'fs';\nimport path from 'path';\nimport _ from 'lodash';\nimport mime from 'mime';\n\nclass ZaioOpeBase {\n  static Converters = {\n    fileToBase64: {\n      type: 'path',\n      // <img src=\"data:image/png;base64,xxxxx...\" />\n      cvt: (filePath) => {\n        const mimeType = mime.getType(filePath.replace(/^.*\\./, ''));\n        if (mimeType === 'application/octet-stream') throw new Error(`Couldn't get mime from ${filePath}`);\n        const body = fs.readFileSync(filePath, 'base64');\n        return `data:${mimeType};base64,${body}`;\n      },\n    }\n  };\n\n  constructor(config, options) {\n    this.config = config;\n    this.options = options;\n    this.context = {};\n  }\n\n  _cvtArgPath(filePath) {\n    return path.isAbsolute(filePath) ? filePath : path.resolve(`${this.context.fileDir}/${filePath}`);\n  }\n\n  convert(cvtName, value) {\n    if (!cvtName) return value;\n    if (!ZaioOpeBase.Converters[cvtName]) throw new Error(`Converter ${cvtName} is not defined.`);\n    const { type, cvt } = ZaioOpeBase.Converters[cvtName];\n    const argCvt = `_cvtArg${type.charAt(0).toLocaleUpperCase()}${type.substr(1)}`;\n    if (typeof(this[argCvt]) !== 'function') throw new Error(`Converter arg processor ${argCvt} is not defined.`);\n    return cvt(this[argCvt](value));\n  }\n\n  createRequestData(method, data) {\n    const init = this.config.initialValue[method] || {};\n    const convert = this.config.convert || {};\n    return _.fromPairs(_.toPairs(Object.assign(init, data)).map(([key,value]) => [\n      this.mappingKey(key),\n      this.convert(convert[key], value),\n    ]));\n  }\n\n  createRequestHeaders() {\n    return {\n      Authorization: `Bearer ${this.config.token}`,\n      'Content-Type': 'application/json',\n      'Accept': 'application/json',\n    };\n  }\n\n  log(...args) {\n    console.log(...args);\n  }\n\n  err(err) {\n    if (err.response) {\n      // The request was made and the server responded with a status code\n      // that falls out of the range of 2xx\n      console.log(err.response.data);\n      console.log(err.response.status);      // 例：400\n      console.log(err.response.statusText);  // Bad Request\n      console.log(err.response.headers);\n    } else if (err.request) {\n      // The request was made but no response was received\n      // `err.request` is an instance of XMLHttpRequest in the browser and an instance of\n      // http.ClientRequest in node.js\n      console.log(err.request);\n    } else {\n      // Something happened in setting up the request that triggered an Error\n      console.log('Error', err.message);\n    }\n    console.log(err.config);\n    if(err.stack) console.log(err.stack);\n  }\n\n  mappingKey(key) {\n    return this.config.mapping[key] || key;\n  }\n\n  loadContextData() {\n    this.log('** read cahce', this.config.cacheFile);\n    this.context.data = JSON.parse(fs.readFileSync(this.config.cacheFile, 'utf-8'));\n  }\n\n  saveContextData() {\n    this.log('** write cahce', this.config.cacheFile);\n    fs.writeFileSync(this.config.cacheFile, JSON.stringify(this.context.data, null, '  '), 'utf-8');\n  }\n\n  useCache() {\n    return this.options.cache && this.config.cacheFile;\n  }\n\n  findZaico(jan) {\n    return this.context.data.find(z => z[this.mappingKey('jan')] === jan);\n  }\n\n  async beforeRows() {\n    if (this.useCache()) {\n      if (fs.existsSync(this.config.cacheFile)) {\n        this.loadContextData();\n        return;\n      }\n    }\n    const headers = this.createRequestHeaders();\n    this.context.data = [];\n    this.log('** get list', this.config.cacheFile);\n    const res = await axios.get(this.config.apiUrl, { headers }).catch((e) => this.err(e));\n    this.context.data = res.data;\n    if (this.useCache()) {\n      this.saveContextData();\n    }\n  }\n\n  afterRows() { }\n  beforeRow() { }\n  afterRow() { }\n  eachRow() { }\n\n  processFile(filePath) {\n    this.context.filePath = filePath; // 対象ファイル\n    this.context.fileDir = path.dirname(filePath); // 対象dir\n    const jangetterResult = JSON.parse(fs.readFileSync(filePath, 'utf8'));\n    this.log('***', jangetterResult.title, '***');\n    const rows = jangetterResult.rows;\n    if (Array.isArray(rows)) {\n      this.beforeRows(rows);\n      rows.forEach((row => {\n        this.beforeRow(row);\n        this.log('*', row.title);\n        this.eachRow(row);\n        this.afterRow(row);\n      }))\n      this.afterRows(rows);\n    } else {\n      this.log('*** rows is not array.');\n    }\n  }\n}\n\nclass VerifyOperation extends ZaioOpeBase {\n\n  eachRow(row) {\n    const found = this.findZaico(row.jan);\n    const msg = found ? '登録済' : '未登録';\n    this.log(msg, row.jan);\n  }\n}\n\nclass AddOperation extends ZaioOpeBase {\n  async eachRow(row) {\n    const headers = this.createRequestHeaders();\n    const data = this.createRequestData('add', row);\n    // this.log(row,data);\n    const res = await axios.post(this.config.apiUrl, data, { headers }).catch((e) => this.err(e));\n    if (res.data && this.useCache()) {\n      const getRes = await axios.get(`${this.config.apiUrl}/${res.data.data_id}`, { headers }).catch((e) => this.err(e));\n      if (getRes) this.context.data.push(getRes.data);\n    }\n  }\n\n  afterRows() {\n    if (this.useCache()) {\n      this.saveContextData();\n    }\n  }\n}\n\nclass UpdateOperation extends ZaioOpeBase {\n  async eachRow(row) {\n    const found = this.findZaico(row.jan);\n    if (found) {\n      const headers = this.createRequestHeaders();\n      const data = this.createRequestData('update', row);\n      const res = await axios.put(`${this.config.apiUrl}/${found.id}`, data, { headers }).catch((e) => this.err(e));\n    } else {\n      this.log('未登録のため更新できません', row.jan, row.title);\n    }\n  }\n}\n\nclass DeleteOperation extends ZaioOpeBase {\n  async eachRow(row) {\n    const found = this.findZaico(row.jan);\n    if (found) {\n      const headers = this.createRequestHeaders();\n      const res = await axios.delete(`${this.config.apiUrl}/${found.id}`, { headers }).catch((e) => this.err(e));\n    } else {\n      this.log('未登録のため削除できません', row.jan, row.title);\n    }\n  }\n}\n\nexport default {\n  verify: (...args) => new VerifyOperation(...args),\n  add: (...args) => new AddOperation(...args),\n  update: (...args) => new UpdateOperation(...args),\n  delete: (...args) => new DeleteOperation(...args),\n}\n"]}