{"version":3,"sources":["../src/ZaicoRequester.js"],"names":["ZaicoRequester","config","options","_config","_options","_requestCount","Authorization","token","headers","_createRequestHeaders","waitPerCount","_","get","waitMills","console","log","Promise","resolve","args","dryrun","unshift","map","v","undefined","err","response","data","status","statusText","request","message","stack","nul","id","apiUrl","apiFunc","logFunc","_getWaitPromise","res","nextUrl","allData","axios","_createRequestConfig","catch","e","Array","isArray","push","link","m","exec","indexOf","_zaicoOperation","post","code","put","jan","delete"],"mappings":"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","file":"ZaicoRequester.js","sourcesContent":["import axios from 'axios';\nimport _ from 'lodash';\nimport { sleep } from './util/timers';\n\nexport default class ZaicoRequester {\n\n  constructor(config, options) {\n    this._config = config;\n    this._options = options;\n    this._requestCount = 0;\n  }\n\n  _createRequestHeaders() {\n    return {\n      Authorization: `Bearer ${this._config.token}`,\n      'Content-Type': 'application/json',\n      'Accept': 'application/json',\n    };\n  }\n\n  _createRequestConfig() {\n    return {\n      headers: this._createRequestHeaders(),\n    };\n  }\n\n  _getWaitPromise() {\n    const waitPerCount = _.get(this._config, 'waitPerCount', 10);\n    this._requestCount++;\n    if (this._requestCount % waitPerCount < 1) {\n      const waitMills = _.get(this._config, 'waitMills', 2000);\n      if (waitMills > 0) {\n        console.log(`[WAIT][${waitMills}ミリ秒][${this._requestCount}リクエスト]`);\n        return sleep(waitMills);\n      }\n    }\n    return Promise.resolve();\n  }\n\n  log(...args) {\n    if (this._options.dryrun) args.unshift('[DRYRUN]');\n    console.log(...args.map(v => v === undefined ? '\"\"' : v));\n  }\n\n  err(err) {\n    if (err.response) {\n      // The request was made and the server responded with a status code\n      // that falls out of the range of 2xx\n      console.log(err.response.data);\n      console.log(err.response.status);      // 例：400\n      console.log(err.response.statusText);  // Bad Request\n      console.log(err.response.headers);\n    } else if (err.request) {\n      // The request was made but no response was received\n      // `err.request` is an instance of XMLHttpRequest in the browser and an instance of\n      // http.ClientRequest in node.js\n      console.log(err.request);\n    } else {\n      // Something happened in setting up the request that triggered an Error\n      console.log('Error', err.message);\n    }\n    console.log(err.config);\n    if (err.stack) console.log(err.stack);\n    return Promise.resolve(nul);\n  }\n\n  apiUrl(id = '') {\n    return id ? `${this._config.apiUrl}/${id}` : this._config.apiUrl;\n  }\n\n  async _zaicoOperation(apiFunc, logFunc) {\n    await this._getWaitPromise();\n    const res = (this._options.dryrun) ? {} : await apiFunc();\n    logFunc(res);\n    return res;\n  }\n\n  async list() {\n    let nextUrl = `${this._config.apiUrl}?page=1`; // 先頭ページからアクセス\n    const allData = [];\n    while (nextUrl) {\n      await this._getWaitPromise();\n      this.log('** get list', nextUrl);\n      const res = await axios.get(nextUrl, this._createRequestConfig()).catch((e) => this.err(e));\n      nextUrl = undefined;\n      if (res && Array.isArray(res.data)) {\n        allData.push(...res.data);\n        const link = res.headers.link;\n        let m;\n        if (link && (m = /<([^>]+)>; *rel=\"next\"/.exec(link)) && m[1].indexOf('?page') > 0) {\n          nextUrl = m[1];\n        }\n      }\n    }\n    return allData;\n  }\n\n  async info(id) {\n    return await this._zaicoOperation(async () => {\n      return await axios.get(this.apiUrl(id), this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n    });\n  }\n\n  async add(data) {\n    return await this._zaicoOperation(async () => {\n      return await axios.post(this.apiUrl(), data, this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n      this.log('追加', data.code, _.get(res, 'data.data_id', ''));\n    });\n  }\n\n  async update(id, data) {\n    return await this._zaicoOperation(async () => {\n      return await axios.put(this.apiUrl(id), data, this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n      this.log('更新', data.code, id);\n    });\n  }\n\n  async remove(id, jan) {\n    return await this._zaicoOperation(async () => {\n      return await axios.delete(this.apiUrl(id), this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n      this.log('削除', jan, id);\n    });\n  }\n}\n"]}