{"version":3,"sources":["../src/ZaicoRequester.js"],"names":["ZaicoRequester","config","options","Authorization","token","headers","_createRequestHeaders","args","dryrun","unshift","log","map","v","undefined","err","response","console","data","status","statusText","request","message","stack","Promise","resolve","nul","id","apiUrl","apiFunc","logFunc","res","nextUrl","allData","axios","get","_createRequestConfig","catch","e","Array","isArray","push","link","m","exec","indexOf","_zaicoOperation","post","code","_","put","jan","delete"],"mappings":"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","file":"ZaicoRequester.js","sourcesContent":["import axios from 'axios';\nimport _ from 'lodash';\n\nexport default class ZaicoRequester {\n\n  constructor(config, options) {\n    this.config = config;\n    this.options = options;\n  }\n\n  _createRequestHeaders() {\n    return {\n      Authorization: `Bearer ${this.config.token}`,\n      'Content-Type': 'application/json',\n      'Accept': 'application/json',\n    };\n  }\n\n  _createRequestConfig() {\n    return {\n      headers: this._createRequestHeaders(),\n    };\n  }\n\n  log(...args) {\n    if (this.options.dryrun) args.unshift('[DRYRUN]');\n    console.log(...args.map(v => v === undefined ? '\"\"' : v));\n  }\n\n  err(err) {\n    if (err.response) {\n      // The request was made and the server responded with a status code\n      // that falls out of the range of 2xx\n      console.log(err.response.data);\n      console.log(err.response.status);      // 例：400\n      console.log(err.response.statusText);  // Bad Request\n      console.log(err.response.headers);\n    } else if (err.request) {\n      // The request was made but no response was received\n      // `err.request` is an instance of XMLHttpRequest in the browser and an instance of\n      // http.ClientRequest in node.js\n      console.log(err.request);\n    } else {\n      // Something happened in setting up the request that triggered an Error\n      console.log('Error', err.message);\n    }\n    console.log(err.config);\n    if (err.stack) console.log(err.stack);\n    return Promise.resolve(nul);\n  }\n\n  apiUrl(id = '') {\n    return id ? `${this.config.apiUrl}/${id}` : this.config.apiUrl;\n  }\n\n  async _zaicoOperation(apiFunc, logFunc) {\n    const res = (this.options.dryrun) ? {} : await apiFunc();\n    logFunc(res);\n    return res;\n  }\n\n  async list() {\n    let nextUrl = `${this.config.apiUrl}?page=1`; // 先頭ページからアクセス\n    const allData = [];\n    while (nextUrl) {\n      this.log('** get list', nextUrl);\n      const res = await axios.get(nextUrl, this._createRequestConfig()).catch((e) => this.err(e));\n      nextUrl = undefined;\n      if (res && Array.isArray(res.data)) {\n        allData.push(...res.data);\n        const link = res.headers.link;\n        let m;\n        if (link && (m = /<([^>]+)>; *rel=\"next\"/.exec(link)) && m[1].indexOf('?page') > 0) {\n          nextUrl = m[1];\n        }\n      }\n    }\n    return allData;\n  }\n\n  async info(id) {\n    return await this._zaicoOperation(async () => {\n      return await axios.get(this.apiUrl(id), this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n    });\n  }\n\n  async add(data) {\n    return await this._zaicoOperation(async () => {\n      return await axios.post(this.apiUrl(), data, this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n      this.log('追加', data.code, _.get(res, 'data.data_id', ''));\n    });\n  }\n\n  async update(id, data) {\n    return await this._zaicoOperation(async () => {\n      return await axios.put(this.apiUrl(id), data, this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n      this.log('更新', data.code, id);\n    });\n  }\n\n  async remove(id, jan) {\n    return await this._zaicoOperation(async () => {\n      return await axios.delete(this.apiUrl(id), this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n      this.log('削除', jan, id);\n    });\n  }\n}\n"]}