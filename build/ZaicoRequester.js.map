{"version":3,"sources":["../src/ZaicoRequester.js"],"names":["ZaicoRequester","config","options","_config","_options","_requestCount","Authorization","token","headers","_createRequestHeaders","waitPerCount","_","get","waitMills","console","log","Promise","resolve","args","dryrun","unshift","map","v","undefined","err","response","data","status","statusText","request","message","stack","nul","id","apiUrl","getDummy","apiFunc","logFunc","_getWaitPromise","res","arrWriter","nextUrl","count","cchk","requestMaxPage","axios","_createRequestConfig","catch","e","Array","isArray","write","link","m","exec","indexOf","end","data_id","Object","assign","did","Math","random","toString","substring","_zaicoOperation","_dummy","post","code","put","jan","delete"],"mappings":"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","file":"ZaicoRequester.js","sourcesContent":["import axios from 'axios';\nimport _ from 'lodash';\nimport { sleep } from './util/timers';\n\nexport default class ZaicoRequester {\n\n  constructor(config, options) {\n    this._config = config;\n    this._options = options;\n    this._requestCount = 0;\n  }\n\n  _createRequestHeaders() {\n    return {\n      Authorization: `Bearer ${this._config.token}`,\n      'Content-Type': 'application/json',\n      'Accept': 'application/json',\n    };\n  }\n\n  _createRequestConfig() {\n    return {\n      headers: this._createRequestHeaders(),\n    };\n  }\n\n  _getWaitPromise() {\n    const waitPerCount = _.get(this._config, 'waitPerCount');\n    this._requestCount++;\n    if (this._requestCount % waitPerCount < 1) {\n      const waitMills = _.get(this._config, 'waitMills');\n      if (waitMills > 0) {\n        console.log(`[WAIT][${waitMills}ミリ秒][${this._requestCount}リクエスト]`);\n        return sleep(waitMills);\n      }\n    }\n    return Promise.resolve();\n  }\n\n  log(...args) {\n    if (this._options.dryrun) args.unshift('[DRYRUN]');\n    console.log(...args.map(v => v === undefined ? '\"\"' : v));\n  }\n\n  err(err) {\n    if (err.response) {\n      // The request was made and the server responded with a status code\n      // that falls out of the range of 2xx\n      console.log(err.response.data);\n      console.log(err.response.status);      // 例：400\n      console.log(err.response.statusText);  // Bad Request\n      console.log(err.response.headers);\n    } else if (err.request) {\n      // The request was made but no response was received\n      // `err.request` is an instance of XMLHttpRequest in the browser and an instance of\n      // http.ClientRequest in node.js\n      console.log(err.request);\n    } else {\n      // Something happened in setting up the request that triggered an Error\n      console.log('Error', err.message);\n    }\n    console.log(err.config);\n    if (err.stack) console.log(err.stack);\n    return Promise.resolve(nul);\n  }\n\n  apiUrl(id = '') {\n    return id ? `${this._config.apiUrl}/${id}` : this._config.apiUrl;\n  }\n\n  async _zaicoOperation(getDummy, apiFunc, logFunc) {\n    await this._getWaitPromise();\n    const res = (this._options.dryrun) ? getDummy() : await apiFunc();\n    logFunc(res);\n    return res;\n  }\n\n  async listToArrayWriter(arrWriter) {\n    let nextUrl = `${this._config.apiUrl}?page=1`; // 先頭ページからアクセス\n    let count = 0;\n    const cchk = this._config.requestMaxPage <= 0\n      ? () => true\n      : () => count++ < this._config.requestMaxPage;\n    while (nextUrl && cchk()) {\n      await this._getWaitPromise();\n      this.log('** get listToArrayWriter', nextUrl);\n      const res = await axios.get(nextUrl, this._createRequestConfig()).catch((e) => this.err(e));\n      nextUrl = undefined;\n      if (res && Array.isArray(res.data)) {\n        arrWriter.write(res.data);\n        const link = res.headers.link;\n        let m;\n        if (link && (m = /<([^>]+)>; *rel=\"next\"/.exec(link)) && m[1].indexOf('?page') > 0) {\n          nextUrl = m[1];\n        }\n      }\n    }\n    await arrWriter.end();\n  }\n\n  _dummy(id) {\n    const res = { data: { } };\n    if (typeof id === 'string') res.data.data_id = id;\n    if (typeof id === 'object') Object.assign(res.data, id);\n    if (!res.data.data_id && res.data.id) res.data.data_id = res.data.id;\n    if (!res.data.data_id && !res.data.id) {\n      const did = Math.random().toString(36).substring(7);\n      res.data.id = did;\n      res.data.data_id = did;\n    }\n    return res;\n  }\n\n  async info(id) {\n    return await this._zaicoOperation(() => ({}), async () => {\n      return await axios.get(this.apiUrl(id), this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n    });\n  }\n\n  async add(data) {\n    return await this._zaicoOperation(() => this._dummy(data), async () => {\n      return await axios.post(this.apiUrl(), data, this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n      this.log('追加', data.code, _.get(res, 'data.data_id', ''));\n    });\n  }\n\n  async update(id, data) {\n    return await this._zaicoOperation(() => this._dummy(data), async () => {\n      return await axios.put(this.apiUrl(id), data, this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n      this.log('更新', data.code, id);\n    });\n  }\n\n  async remove(id, jan) {\n    return await this._zaicoOperation(() => this._dummy(id), async () => {\n      return await axios.delete(this.apiUrl(id), this._createRequestConfig()).catch((e) => this.err(e));\n    }, (res) => {\n      this.log('削除', jan, id);\n    });\n  }\n}\n"]}